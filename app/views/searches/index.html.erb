<body class="mypage search-page-wrapper">
  <div class="search-page">
    <h1>YouTube Shorts を探す</h1>
    <p class="subtitle">ショート動画に特化した検索</p>

    <%= form_with url: searches_path, method: :get, local: true do %>
      <%= text_field_tag :keyword, params[:keyword],
        id: "keyword",
        placeholder: "例：親子丼の作り方" %>
      <%= submit_tag "検索" %>
    <% end %>

    <% if @videos.present? %>
      <p class="search-count">
        「<%= params[:keyword] %>」の検索結果
      </p>

      <div id="video-grid" class="video-grid">
        <% @videos.each do |video| %>
          <% snippet  = video["snippet"] %>
          <% video_id = video.dig("id", "videoId") %>

          <% video_card = SavedVideo.new(
            title: snippet["title"],
            url: "https://www.youtube.com/embed/#{video_id}",
            nickname: snippet["channelTitle"],
            username: nil
          ) %>

          <%= render "shared/video_card", video: video_card do %>
            <% if user_signed_in? %>
              <% if (saved = current_user.saved_videos.find_by(url: video_card.url)) %>
                <%= button_to "保存解除",
                      saved_video_path(saved),
                      method: :delete,
                      data: { turbo: false },
                      class: "btn btn-unsave-search" %>
              <% else %>
                <%= form_with model: video_card,
                      url: saved_videos_path,
                      method: :post,
                      data: { turbo: false } do |f| %>
                  <%= f.hidden_field :title %>
                  <%= f.hidden_field :url %>
                  <%= f.hidden_field :nickname %>
                  <%= f.hidden_field :username %>
                  <%= f.submit "保存", class: "btn btn-saved-search" %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <p>動画が見つかりませんでした。</p>
    <% end %>

    <div id="sentinel"></div>

    <div class="actions center">
      <%= link_to "マイページ", mypage_path, class: "btn btn-mypage-search" %>
    </div>

  </div>

</body>

