<body class="mypage search-page-wrapper">
  <div class="search-page">
    <h1>動画を探す</h1>

    <%= form_with url: searches_path, method: :get do |f| %>
      <%= f.text_field :keyword, placeholder: "検索ワードを入力" %>
      <%= f.submit "検索" %>
    <% end %>

    <% if params[:keyword].present? %>
      <h2>検索ワード: <%= params[:keyword] %></h2>
      <p class="search-count">
        <%= (params[:page] || 1) %>ページ目を表示中（<%= @videos.size %>件）
      </p>
    <% end %>

    <% if @videos.present? %>
      <div class="video-grid">
        <% @videos.each do |video| %>
          <% title = video["desc"] || video["title"] || "タイトルなし" %>
          <% video_id = video["id"] %>

          <div class="video-item">

            <!-- =========================
                 ヘッダー（投稿者 + タイトル）
                 ========================= -->
            <% creator = video["author"] rescue nil %>
            <% nickname = creator&.dig("nickname") %>
            <% username = creator&.dig("unique_id") %>

            <div class="video-card-header">
              <% if nickname.present? %>
                <div class="creator">
                  <strong><%= nickname %></strong>
                  <% if username.present? %>
                    <span class="username">@<%= username %></span>
                  <% end %>
                </div>
              <% end %>

              <!-- タイトル（2行省略） -->
              <p class="video-title"><%= title %></p>
            </div>

            <!-- =========================
                 TikTok 埋め込み
             ========================= -->
            <% if video_id.present? %>
              <div class="video-frame">
                <iframe
                  src="https://www.tiktok.com/embed/v2/<%= video_id %>"
                  allowfullscreen>
                </iframe>
              </div>

              <!-- =========================
                   保存ボタン
              ========================= -->
              <% video_url = "https://www.tiktok.com/embed/v2/#{video_id}" %>

              <div class="video-footer">
                <% if @saved_urls.include?(video_url) %>
                  <!-- 保存済み -->
                  <button class="btn btn-saved-search saved" disabled>
                    保存済み
                  </button>
                <% else %>
                  <!-- 未保存 -->
                  <%= form_with model: SavedVideo.new,
                                url: saved_videos_path,
                                method: :post,
                                data: { turbo: false } do |f| %>
                    <%= f.hidden_field :title, value: title %>
                    <%= f.hidden_field :url, value: video_url %>
                    <%= f.hidden_field :nickname, value: nickname %>
                    <%= f.hidden_field :username, value: username %>
                    <%= f.submit "保存", class: "btn btn-saved-search" %>
                  <% end %>
                <% end %>
              </div>

            <% else %>
              <p>▶️ 埋め込みURLが見つかりません。</p>
            <% end %>

          </div>
        <% end %>
      </div>
    <% else %>
      <p>動画が見つかりませんでした。</p>
    <% end %>

    <% if @videos.present? %>
      <% current_page = (params[:page] || 1).to_i %>

      <div class="pagination google-pagination">
        <% if current_page > 1 %>
          <%= link_to "＜",
              searches_path(keyword: params[:keyword], page: current_page - 1),
              class: "page-nav" %>
        <% end %>
        <% start_page = [current_page - 3, 1].max %>
        <% end_page   = current_page + 3 %>

        <% (start_page..end_page).each do |p| %>
          <% if p == current_page %>
            <span class="page-number active"><%= p %></span>
          <% else %>
            <%= link_to p,
                searches_path(keyword: params[:keyword], page: p),
                class: "page-number" %>
          <% end %>
        <% end %>
        <%= link_to "＞",
            searches_path(keyword: params[:keyword], page: current_page + 1),
            class: "page-nav" %>
      </div>
    <% end %>


    <div class="actions center">
      <%= link_to "マイページ", mypage_path, class: "btn btn-mypage-main" %>
    </div>
  </div>
</body>
